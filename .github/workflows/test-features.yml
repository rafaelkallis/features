name: Test features
on:
  push:
    branches: "main"
    paths:
      - src/*/**
      - test/*/**
      - .github/workflows/test-features.yml
  pull_request:
    paths:
      - src/*/**
      - test/*/**
      - .github/workflows/test-features.yml
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  list-features:
    outputs:
      relevant-features: ${{ steps.list-features.outputs.relevant-features }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0
      - id: list-features
        uses: devcontainers-community/list-features@v2

  test-autogenerated:
    needs: list-features
    strategy:
      fail-fast: false
      matrix:
        feature: ${{ fromJSON(needs.list-features.outputs.relevant-features) }}
        baseImage:
          - "ubuntu:24.04"
          - "ubuntu:22.04"
          - "debian:13"
          - "debian:12"
          - "mcr.microsoft.com/devcontainers/base:ubuntu"
          - "mcr.microsoft.com/devcontainers/base:debian"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Install devcontainer CLI
        run: npm install -g @devcontainers/cli

      # - name: Install Claude Code for '${{ matrix.feature.id }}'
      #   if: contains(toJSON(matrix.feature.installsAfter), 'ghcr.io/anthropics/devcontainer-features/claude-code')
      #   run: npm install -g @anthropic-ai/claude-code
      - name: Create mock Claude config files
        if: contains(toJSON(matrix.feature.installsAfter), 'ghcr.io/anthropics/devcontainer-features/claude-code')
        run: |
          mkdir -p ~/.claude
          echo "{}" > ~/.claude.json

      - name: Generating tests for '${{ matrix.feature.id }}' against '${{ matrix.baseImage }}'
        run: devcontainer features test --skip-scenarios -f ${{ matrix.feature.id }} -i ${{ matrix.baseImage }}
  
  test-scenarios:
    needs: list-features
    strategy:
      fail-fast: false
      matrix:
        feature: ${{ fromJSON(needs.list-features.outputs.relevant-features) }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Install devcontainer CLI
        run: npm install -g @devcontainers/cli

      # - name: Install Claude Code for '${{ matrix.feature.id }}'
      #   if: contains(toJSON(matrix.feature.installsAfter), 'ghcr.io/anthropics/devcontainer-features/claude-code')
      #   run: npm install -g @anthropic-ai/claude-code
      - name: Create mock Claude config files
        if: contains(toJSON(matrix.feature.installsAfter), 'ghcr.io/anthropics/devcontainer-features/claude-code')
        run: |
          mkdir -p ~/.claude
          echo "{}" > ~/.claude.json

      - name: Testing scenarios for '${{ matrix.feature.id }}'
        run: devcontainer features test -f ${{ matrix.feature.id }} --skip-autogenerated
